<link rel="Up" href="index.html" title="nosh Guide" />
<link rel="Stylesheet" type="text/css" href="guide.css" title="Guide default style" />
<title>Building the toolset from source</title>
<h1 class="Ruled">Building the toolset from source</h1>

<p>
The <a href="index.html">nosh toolset</a> is known to build, run, and work on FreeBSD 10, PC-BSD 10, NetBSD 10, Debian Linux version 12, and OpenBSD version 5.9.
It <em>should</em> similarly build, run, and work on any modern BSD and on any modern Linux flavour.
Most expected tweaks in order to make it work on other operating systems have been concentrated in particular areas.
</p>

<p>
The source is structured as a <a href="https://jdebp.uk/FGA/slashpackage.html">slashpackage-style package</a>.
</p>

<p>
It requires <a href="https://jdebp.uk/Softwares/redo/">redo</a>, <code>install</code>, <code>xmlto</code>, the host operating system's equivalent of <a href="https://debian.org/doc/debian-policy/ch-source.html#package-relationships">Debian's <code>build-essential</code> tools</a> (whatever thay may be), and a POSIX-conformant operating system (with the standard utilities present) to build.
(See the Archnosh documentation for the Arch Linux equivalents, for example.)
</p>

<p>
It builds with the g++ and clang++ compilers.
The build system attempts to autodetect the available compiler, as well as various operating-system-dependant features.
The way that it autodetects features was in some of Daniel J. Bernstein's softwares: a short test program that references the desired features, and a header that defines a preprocessor macro according to whether the build system can successfully compile and link the test program.
(People who absolutely must can override the compiler autodetection with an environment variable.)
</p>

<p>
It makes use of various <code>&hellip;at()</code> system calls from POSIX.1:2008, for security and safety.
It also makes use of the kqueue mechanism (throughout on BSD, on Linux where library bugs don't make it unusable).
</p>

<link rel="Section" href="#Build" title="Building the toolset itself">
<h2 class="Ruled" id="Build">Building the toolset itself</h2>

<p> To just build the toolset from source, without packaging the binaries: </p>
<blockquote><code>package/compile</code></blockquote>

<p>This gives you:</p>
<ul>
<li> binaries in <code>command/</code>, which you can just add to your <code>PATH</code> environment variable or symbolically link to;
<li> manual pages in <code>manual/</code>, which you can just add to your <code>MANPATH</code> environment variable or symbolically link to;
<li> examples and various prepared configuration files and service bundles in <code>config/</code>, which you will need to copy to apprpriate places; and
<li> the Guide in <code>guide/</code>.
</ul>

<p> 
The build process updates files in these directories atomically.
It doesn't create part-written executables or other files at their final names.
So you can run things straight out of these directories whilst rebuilding.
</p>

<link rel="Section" href="#Clean" title="Cleaning the build area">
<h2 class="Ruled" id="Clean">Cleaning the build area</h2>

<p>To clean the build run</p>
<blockquote><code>package/clean</code></blockquote> <p> or just <code>rm -r build/</code></p>

<p>To clean the build, packaging, and built files run</p>
<blockquote><code>package/distclean</code></blockquote> <p> or just <code>rm -r build/ command/ manual/ config/ guide/</code></p>

<link rel="Section" href="#Binary" title="Packaging the binaries">
<h2 class="Ruled" id="Binary">Packaging the binaries</h2>

<p>To build installable binary packages on FreeBSD, TrueOS, NetBSD, or OpenBSD run</p>
<blockquote><pre>package/bsd/prepare &amp;&amp; bsd/rules clean build binary</pre></blockquote>

<p>
On FreeBSD and TrueOS this requires pkg version 1.2 or later in order to avoid segmentation faults and other bugs.
So ensure that pkg is up to that version in your ports tree.
</p>

<p>To build the binary packages on Debian Linux run</p>
<blockquote><pre>package/debian/prepare &amp;&amp; dpkg-buildpackage -b -uc</pre></blockquote>

<link rel="Section" href="#ManualInstallation" title="Manual installation">
<h2 class="Ruled" id="ManualInstallation">Manual installation</h2>

<p>
Manual installation is a complex process and not for the faint of heart.
</p>

<p>
Symbolically linking to stuff in <code>manual/</code> and <code>command/</code> is better than just putting those two directories on your <code>PATH</code> and <code>MANPATH</code> as there are a lot of shim commands that might conflict with existing commands on your system.
Generally the way to manage such a symbolic link farm is with something like <a href="https://wiki.debian.org/DebianAlternatives">Debian's alternatives system</a>, or a more sophisticated version of the <a href="https://code.dogmap.org/sptools/sp-links/"><code>sp-links</code></a> tool from <a href="https://code.dogmap.org/sptools/">Paul Jarc's sptools toolset</a>, which are both beyond the scope of this <i>Guide</i>.
</p>

<p>
Separating out all of the stuff in <code>config/</code> and copying the necessary parts of it (not all of it being required on every operating system) is perhaps best achieved by building the binary packages and seeing how the package staging areas underneath (on the BSDs) <code>bsd/nosh-<i>pkgbase</i>/</code> or (on Debian) <code>debian/nosh-<i>pkgbase</i>/</code> are laid out.
Likewise, the generated manifests and the pre- and post- installation and deinstallation maintenance scripts in those same subdirectories show what user/group entries to set up in the system account database, what ACLs and permissions to apply to (for example) log directories, and how to do certain special installation/deinstallation steps required for particular services.
</p>

<p>
Note that the older <code>package/export</code> mechanism is no longer available; because there are simply too many optional and potentially conflicting parts for exporting everything as one lump to be feasible.
</p>

<h3 class="Ruled" id="MaintenanceScriptGeneration">Maintenance script generation</h3>

<p>
The pre- and post- installation and deinstallation maintenance scripts are themselves generated files.
They are a combination of:
</p>
<ul>
<li><p> a pseudo-declarative list, of things like special file owning users and services that are paired with dedicated logging services, in a <code>{bsd,debian}/nosh-<i>pkgbase</i>.p</code> file; </p></li>
<li><p> a shell function library, implementing the pseudo-declarations, in a <code>{bsd,debian}/{pre,post}-{,de}install.funcs</code> file; and </p></li>
<li><p> a small amount of glue to load the right shell function library and run the list. </p></li>
</ul>

<p>
The "plist" mechanisms in pkgsrc and pkg_ng do not have anywhere near enough functionality for the job; but this can be thought of as plists extended to be able to preset/disable services, set ACLs for dedicated r&ocirc;le accounts, create log directories, and set up non-trivial logging service relationships.
</p>

<link rel="Section" href="#Porting" title="Porting the toolset">
<h2 class="Ruled" id="Porting">
Porting the toolset to other operating systems
</h2>

<p>
The toolset is packaged as multiple binary packages built from a single source package.
</p>

<p>
For operating systems outwith the core ones that have binary packages built for them by the author, the source package requires patching.
This is in two general areas:
</p>

<ul>
<li><p>
In <code>package/stage</code> patch the operating system's choices of directory layout in the section marked as distributor-patchable stuff.
</p></li>
<li><p>
In the following files patch to select an appropriate variant of various Desktop Bus configurations, according to whatever choices of non-<code>PATH</code> directories and user account names are made by the packages on the operating system.
</p>
<ul>
<li><code>source/convert/per-user/per-user.conf.do</code>
<li><code>source/convert/per-user/gconfd.service.do</code>
<li><code>source/convert/per-user/at-spi-dbus-bus.service.do</code>
<li><code>source/services/dbus-daemon.service.do</code>
<li><code>source/services/dbus-broker.service.do</code>
<li><code>source/services/system-wide.conf.do</code>
<li><code>source/systemd/service-manager.socket.do</code>
</ul>
</li>
<li><p>
In the following files patch to select appropriate pathnames, according to whatever choices are made by the packages on the operating system.
</p>
<ul>
<li><code>source/convert/rc.conf.do</code> (in particular <code>entropy_file</code>)
</ul>
</li>
</ul>
