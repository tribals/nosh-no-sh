<?xml version="1.0" encoding="UTF-8"?>
<!-- **************************************************************************
.... For copyright and licensing terms, see the file named COPYING.
.... **************************************************************************
.-->
<?xml-stylesheet href="docbook-xml.css" type="text/css"?>

<refentry id="console-fb-realizer">

<refmeta xmlns:xi="http://www.w3.org/2001/XInclude">
<refentrytitle>console-fb-realizer</refentrytitle>
<manvolnum>1</manvolnum>
<refmiscinfo class="manual">user commands</refmiscinfo>
<refmiscinfo class="source">nosh</refmiscinfo>
<xi:include href="version.xml" />
</refmeta>

<refnamediv>
<refname>console-fb-realizer</refname>
<refname>console-evdev-realizer</refname>
<refname>console-uugen-hid-realizer</refname>
<refname>console-uhid-realizer</refname>
<refname>console-pcat-mouse-realizer</refname>
<refname>console-pcat-keyboard-realizer</refname>
<refname>console-ps2-mouse-realizer</refname>
<refname>console-kvt-realizer</refname>
<refpurpose>realize a user-space virtual terminal on FBIO, KBIO, USB, evdev, or KVT devices</refpurpose>
</refnamediv>

<refsynopsisdiv>
<refsection><title>BSDs</title>
<cmdsynopsis>
<command>console-ugen-hid-realizer</command>
<arg choice='opt'>--mouse-primary</arg>
<arg choice='req'><replaceable>ugendevicename</replaceable></arg>
</cmdsynopsis>
<cmdsynopsis>
<command>console-uhid-realizer</command>
<arg choice='opt'>--mouse-primary</arg>
<arg choice='req'><replaceable>uhiddevicename</replaceable></arg>
</cmdsynopsis>
<cmdsynopsis>
<command>console-pcat-mouse-realizer</command>
<arg choice='opt'>--mouse-primary</arg>
<arg choice='req'><replaceable>sysmousedevicename</replaceable></arg>
</cmdsynopsis>
<cmdsynopsis>
<command>console-pcat-keyboard-realizer</command>
<arg choice='opt'>--mouse-primary</arg>
<arg choice='req'><replaceable>atkbddevicename</replaceable></arg>
</cmdsynopsis>
<cmdsynopsis>
<command>console-wscons-realizer</command>
<arg choice='opt'>--mouse-primary</arg>
<arg choice='req'><replaceable>wsconsdevicename</replaceable></arg>
</cmdsynopsis>
<cmdsynopsis>
<command>console-fb-realizer</command>
<arg choice='opt'>--font-light-r <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-light-o <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-light-i <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-medium-r <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-medium-o <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-medium-i <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-demibold-r <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-demibold-o <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-demibold-i <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-bold-r <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-bold-o <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-bold-i <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont-faint-r <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont-faint-o <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont-faint-i <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont-normal-r <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont-normal-o <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont-normal-i <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont <replaceable>filename</replaceable></arg>
<arg choice='opt'>--quadrant <replaceable>number</replaceable></arg>
<arg choice='opt'>--wrong-way-up</arg>
<arg choice='opt'>--bold-as-colour</arg>
<arg choice='opt'>--80-columns</arg>
<arg choice='opt'>--mouse-primary</arg>
<arg choice='req'><replaceable>fbname</replaceable></arg>
</cmdsynopsis>
<cmdsynopsis>
<command>console-kvt-realizer</command>
<arg choice='opt'>--font-light-r <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-light-o <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-light-i <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-medium-r <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-medium-o <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-medium-i <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-demibold-r <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-demibold-o <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-demibold-i <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-bold-r <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-bold-o <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-bold-i <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont-faint-r <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont-faint-o <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont-faint-i <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont-normal-r <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont-normal-o <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont-normal-i <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont <replaceable>filename</replaceable></arg>
<arg choice='opt'>--quadrant <replaceable>number</replaceable></arg>
<arg choice='opt'>--wrong-way-up</arg>
<arg choice='opt'>--bold-as-colour</arg>
<arg choice='opt'>--80-columns</arg>
<arg choice='opt'>--mouse-primary</arg>
</cmdsynopsis>
</refsection>
<refsection><title>Linux</title>
<cmdsynopsis>
<command>console-evdev-realizer</command>
<arg choice='opt'>--mouse-primary</arg>
<arg choice='req'><replaceable>evdevdevicename</replaceable></arg>
</cmdsynopsis>
<cmdsynopsis>
<command>console-ps2-mouse-realizer</command>
<arg choice='opt'>--mouse-primary</arg>
<arg choice='req'><replaceable>ps2mousedevicename</replaceable></arg>
</cmdsynopsis>
<cmdsynopsis>
<command>console-fb-realizer</command>
<arg choice='opt'>--font-light-r <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-light-o <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-light-i <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-medium-r <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-medium-o <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-medium-i <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-demibold-r <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-demibold-o <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-demibold-i <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-bold-r <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-bold-o <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-bold-i <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont-faint-r <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont-faint-o <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont-faint-i <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont-normal-r <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont-normal-o <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont-normal-i <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont <replaceable>filename</replaceable></arg>
<arg choice='opt'>--quadrant <replaceable>number</replaceable></arg>
<arg choice='opt'>--wrong-way-up</arg>
<arg choice='opt'>--bold-as-colour</arg>
<arg choice='opt'>--80-columns</arg>
<arg choice='opt'>--mouse-primary</arg>
<arg choice='req'><replaceable>fbname</replaceable></arg>
</cmdsynopsis>
<cmdsynopsis>
<command>console-kvt-realizer</command>
<arg choice='opt'>--font-light-r <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-light-o <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-light-i <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-medium-r <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-medium-o <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-medium-i <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-demibold-r <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-demibold-o <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-demibold-i <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-bold-r <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-bold-o <replaceable>filename</replaceable></arg>
<arg choice='opt'>--font-bold-i <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont-faint-r <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont-faint-o <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont-faint-i <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont-normal-r <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont-normal-o <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont-normal-i <replaceable>filename</replaceable></arg>
<arg choice='opt'>--vtfont <replaceable>filename</replaceable></arg>
<arg choice='opt'>--quadrant <replaceable>number</replaceable></arg>
<arg choice='opt'>--wrong-way-up</arg>
<arg choice='opt'>--bold-as-colour</arg>
<arg choice='opt'>--80-columns</arg>
<arg choice='opt'>--mouse-primary</arg>
</cmdsynopsis>
</refsection>
</refsynopsisdiv>

<refsection><title>Description</title>

<para>
These are the I/O back ends for a (user-space) virtual terminal, that realize that virtual terminal with various input and output devices.
</para>

<para>
Each one opens the back end interfaces of a user-space virtual terminal and opens the I/O devices (if any) specified by command line options and the particular command.
The I/O devices are the concrete devices with which the user-space virtual terminal is to be (partly or wholly) realized.
It is the user's responsibility to ensure that these refer to the same, single, physical user station.
</para>

<para>
They then enter a loop where they simultaneously:
</para>

<itemizedlist>

<listitem>
<para>
write all data received from the input devices to the input FIFO for the virtual terminal, translating to the abstract keyboard and mouse; and
</para>
</listitem>

<listitem>
<para>
(if the <arg choice='plain'>--mouse-primary</arg> option is used) writes all mouse state changes recorded in the <filename><replaceable>mouse-state-file</replaceable></filename> to the input FIFO; and
</para>
</listitem>

<listitem>
<para>
render the contents of the character/attribute buffer file for the virtual terminal on any output device.
</para>
</listitem>

</itemizedlist>

<para>
I/O devices may be shared with other subsystems, or used exclusively.
</para>

<para>
Mouse and keyboard devices can be aggregated with other mouse and keyboard devices, or separated from them, by choosing whether to share mouse/keyboard state files amongst realizers.
</para>
<itemizedlist>
<listitem>
<para>
Shared keyboard state comprises information about the press, latch, and lock states of the various modifier keys.
Sharing this with mouse device realizers enables modifier information to be generated in mouse events; without which all mouse events will have modifier flags set to zero.
</para>
</listitem>
<listitem>
<para>
Shared mouse state comprises information about the mouse position and limits of its various axes, and the instantaneous combined states of buttons and wheels.
</para>
</listitem>
</itemizedlist>

</refsection>

<refsection><title>Specifying I/O devices</title>

<para>
I/O devices are specified by the choice of command, and thus their various command-line options.
</para>

<refsection><title>The superior (or sole) choices</title>

<para>
For best results, <command>console-ugen-hid-realizer</command> should be employed to handle HIDs on the BSDs, <command>console-evdev-realizer</command> should be employed to handle HIDs on Linux, and (on both) <command>console-fb-realizer</command> to handle output using a framebuffer device.
If VT switching support is needed, instead of <command>console-fb-realizer</command> substitute <command>console-kvt-realizer</command> to handle both VT switching and I/O using a VT-supplied framebuffer and keyboard.
</para>

<variablelist>

<varlistentry>
<term><arg choice='plain'><replaceable>ugendevicename</replaceable></arg></term>
<listitem><para>
This command-line option designates the superior choice of input device on the BSDs.
<replaceable>ugendevicename</replaceable> must be the the device file name of a Generic USB device, using the <citerefentry><refentrytitle>ugen</refentrytitle><manvolnum>4</manvolnum></citerefentry> protocol, such as <filename>/dev/ugen0.2</filename> for example.
<command>console-ugen-hid-realizer</command> parses the bus and address from the name and actually opens the interface device names such as <filename>/dev/usb/0.2.0</filename>, <filename>/dev/usb/0.2.1</filename>, and <filename>/dev/usb/0.2.2</filename>.
</para><para>
It queries the "type" of the device (e.g. keyboard, tablet, mouse, and so forth) from the device itself, without need for explicitly describing it to the comand.
It reads the HID I/O report descriptors from the device and from them decides whether the interface has normal keys, consumer device keys, system keys, keyboard LEDs, relative positioning (mice), and absolute positioning (touchscreen).
Any combination of HID I/O in a single USB device can be handled.
Multiple keyboard and mice USB interfaces at the given bus+address are combined, and the program acts as if they are a single giant keyboard/mouse.
</para></listitem>
</varlistentry>

</variablelist>

<varlistentry>
<term><arg choice='plain'><replaceable>evdevdevicename</replaceable></arg></term>
<listitem><para>
This command-line option designates the superior choice of input device on Linux, the Human Input Devices enumerated by the operating system.
On Linux, <replaceable>evdevdevicename</replaceable> must be the device file name of an event device, using the evdev subsystem, such as <filename>/dev/input/event0</filename> for example.
</para><para>
<command>console-evdev-realizer</command> queries the "type" of the device (e.g. keyboard, tablet, mouse, and so forth) from the device itself, without need for explicitly describing it to the comand.
</para><para>
Some BSDs have Linux evdev compatibility subsystems, but Generic USB is superior for two reasons.
First, the compatibility is incomplete by its nature.
Second, even natively evdev hides the extensible nature of the underlying USB HID I/O system.
</para></listitem>
</varlistentry>

<varlistentry>
<term><arg choice='plain'><replaceable>wsconsdevicename</replaceable></arg></term>
<listitem><para>
This command-line option designates the superior choice of input device on BSDs, the Human Input Devices enumerated by the operating system.
<replaceable>wsconsdevicename</replaceable> must be the device file name of a <filename>wskbd</filename> or <filename>wsmouse</filename> device.
</para><para>
All wscons devices (e.g. keyboard, tablet, mouse, and so forth) speak the same event protocol.
</para></listitem>
</varlistentry>

<varlistentry>
<term><arg choice='plain'><replaceable>fbname</replaceable></arg></term>
<listitem><para>
This command-line option option designates a framebuffer output device for realizing the user-space virtual terminal's display.
<replaceable>fbname</replaceable> must be a device that speaks the "fbio" API to programs.
On Linux only framebuffer devices, such as <filename>/dev/fb0</filename>, speak this protocol.
(Remember that "kernel mode setting" device drivers create simple framebuffer devices for programs that use the "fbio" API.)
On the BSDs, kernel virtual terminal devices speak this protocol, and framebuffers are not directly accessible via separate devices.
</para>
<para>
The framebuffer device need not be the same size or height:width ratio as the virtual terminal display.
When it is smaller than the display, the realizer will move the framebuffer around as a "window" onto the virtual terminal display, such that the cursor position is always within the window.
When it is larger than the display, the realizer will align the virtual terminal display to one corner of the framebuffer, as specified by the <arg choice='plain'>--quadrant</arg> command-line option.
It will render the parts of the framebuffer outwith the virtual terminal display area as black.
</para>
<para>
The <arg choice='plain'>--wrong-way-up</arg> command-line option causes the display to be realized the wrong way up, swapping the direction of increasing line numbers.
This is an oft-requested terminal feature, albeit by people who have never actually experienced it.
</para></listitem>
</varlistentry>

</refsection>

<refsection><title>Inferior choices</title>

<variablelist>

<varlistentry>
<term><arg choice='plain'><replaceable>uhiddevicename</replaceable></arg></term>
<listitem><para>
This command-line option designates an inferior choice of input device on the BSDs, the Human Input Devices enumerated by the operating system or created by <citerefentry><refentrytitle>uhidd</refentrytitle><manvolnum>8</manvolnum></citerefentry>.
Linux does not have such devices.
<replaceable>uhiddeviceename</replaceable> must be the device file name of a USB HID device, using the <citerefentry><refentrytitle>uhid</refentrytitle><manvolnum>4</manvolnum></citerefentry> protocol, such as <filename>/dev/uhid0</filename> for example.
<command>console-uhid-realizer</command> queries the "type" of the device (e.g. keyboard, tablet, mouse, and so forth) from the device itself, without need for explicitly describing it on the command line.
</para><caution>
This is inferior to Generic USB because the kernel and <citerefentry><refentrytitle>uhidd</refentrytitle><manvolnum>8</manvolnum></citerefentry> disagree on what the <citerefentry><refentrytitle>uhid</refentrytitle><manvolnum>4</manvolnum></citerefentry> protocol actually is, and produce devices that are not I/O compatible.
Do not use this with devices created by <citerefentry><refentrytitle>uhidd</refentrytitle><manvolnum>8</manvolnum></citerefentry> (which is largely superfluous with these realizers anyway).
</caution></listitem>
</varlistentry>

<varlistentry>
<term><arg choice='plain'><replaceable>sysmousedevicename</replaceable></arg></term>
<listitem><para>
This command-line option designates an inferior choice of input device on the BSDs.
<replaceable>sysmousedevicesname</replaceable> must be a device that speaks the BSD <citerefentry><refentrytitle>mouse</refentrytitle><manvolnum>4</manvolnum></citerefentry> protocol to programs, such as <filename>/dev/sysmouse</filename>, or <filename>/dev/ums0</filename> (created by the kernel), or <filename>/dev/psm0</filename> for examples.
BSD mouse devices, while speaking their own idiosyncratic protocols at "mouse level 1" all have a common "mouse level 2" of operation where they all speak this same protocol.
</para>
<para>
However, this common mouse protocol is limited compared to using the USB HID devices directly.
It has no support for absolute-position pointing devices, such as USB tablets, because the protocol simply does not support the notion of transmitting absolute position information, only relative pointer movements.
</para><para>
Transparent "mouse integration" under some virtual machine systems requires support for absolute-position pointing devices.
(In Oracle VirtualBox, for example, when "mouse integration" is off, host machine mouse input is reported to the guest machine as input from a relative-positioning mouse device; but when "mouse integration" is on, host machine mouse input is reported to the guest machine as input from an absolute-positioning tablet device.)
This type of device cannot work with them.
</para><para>
If used at all this is best used only with the mouse concentrator device, <filename>/dev/sysmouse</filename>, as a backstop catch-all and with PS/2 mice devices.
</para></listitem>
</varlistentry>

<varlistentry>
<term><arg choice='plain'><replaceable>atkbddevicename</replaceable></arg></term>
<listitem><para>
This command-line option designates an inferior choice of input device on the BSDs.
<replaceable>filename</replaceable> must be a device that speaks the "kbio" API to programs.
On the BSDs, <replaceable>atkbddevicename</replaceable> must be an a kernel virtual terminal device or an <citerefentry><refentrytitle>atkbd</refentrytitle><manvolnum>4</manvolnum></citerefentry> device, such as <filename>/dev/atkbd0</filename>, <filename>/dev/kbdmux0</filename>, <filename>/dev/ukbd0</filename>, or <filename>/dev/vkbd0</filename> (created by <citerefentry><refentrytitle>uhidd</refentrytitle><manvolnum>8</manvolnum></citerefentry>) for examples.
</para>
<note>
On Linux, "kbio" devices are not directly accessible via separate devices.
Kernel virtual terminal devices speak this protocol, but the <citerefentry><refentrytitle>console-kvt-realizer</refentrytitle><manvolnum>1</manvolnum></citerefentry> command is used to employ those.
</note>
<para>
This is inferior because the AT Keyboard model does not include things that are accessible via the USB HID protocol and (to a lesser extent) the Linux input event protocol.
Those latter support extra keypads and more keys, including extra extended keys (equals, comma, plus/minus, and brackets on the calculator keypad for examples), consumer device keys (calculator, WWW, and eject for examples), and system keys (power, wake, and sleep).
</para><para>
If used at all this is best used only with the keyboard concentrator device, <filename>/dev/kbdmux0</filename>, as a backstop catch-all.
</para></listitem>
</varlistentry>

<varlistentry>
<term><arg choice='plain'><replaceable>ps2mousedevicename</replaceable></arg></term>
<listitem><para>
This command-line option designates an inferior choice of input device on Linux.
<replaceable>ps2mousdevicename</replaceable> must be a device that speaks the Linux PS/2 mouse protocol to programs, such as <filename>/dev/input/mice</filename> (a backwards-compatibility mouse concentrator provided by the evdev subsystem) for example.
</para>
<note>
BSD PS/2 mouse devices (<citerefentry><refentrytitle>psm</refentrytitle><manvolnum>4</manvolnum></citerefentry>) speak BSD mouse protocols, not a PS/2 protocol.
Do not use <command>console-ps2-mouse-realizer</command> with BSD PS/2 mouse devices.
It is for <emphasis>Linux</emphasis> PS/2 mouse devices, which speak a 3-byte packet PS/2 protocol peculiar to Linux.
</note>
<para>
This is inferior to accessing the mouse via its evdev device.
This protocol has no scope for mice wheels, the Z or W axes, or more than 3 buttons.
It is also poorly effected in some virtual machine systems, which try to enforce a relationship between "mickeys" in the virtual hardware and pixels on the host display, and do not always do that right.
</para></listitem>
</varlistentry>

</variablelist>

</refsection>

<refsection><title>Kernel VTs and device sharing</title>

<refsection><title>The unshared case</title>

<para>
All realizers open their respective I/O devices and retain them open for as long as they run.
On a system where they do not have to be shared with anything else, and are dedicated to realizing user-space virtual terminals, this just works as-is.
One just runs a combination of <command>console-ugen-hid-realizer</command>, <command>console-evdev-realizer</command>, and <command>console-fb-realizer</command> (and any realizers for old PC/AT or PS/2 devices) that continually realize the user-space virtual terminals.
Such a system would be Linux compiled without the <code>CONFIG_VT</code> option and not running an X11 server, for example, or where a secondary framebuffer and a set of input devices are dedicated only to realizing a user-space virtual terminal.
</para>
<note>
<command>console-kvt-realizer</command> is not used in this case.
</note>

</refsection>

<refsection><title>The shared case</title>

<para>
If more than one thing opens an I/O device, however, exactly what part of the system (say) ends up with a key press event from the keyboard can be unpredictable.
This happens when realizers for user-space virtual terminals, the kernel's built-in terminal emulator, the Xorg X11 server, and other things all attempt to use the same I/O devices.
Device sharing is a way that these all negotiate sharing I/O devices.
</para>

<para>
It is done by the participants (<command>console-kvt-realizer</command> and the Xorg server) allocating a (spare) kernel virtual terminal and waiting for acquire and release orders sent by the kernel.
On release, it mutes all of its input devices, with <code>EV_DISABLE</code> passed to <citerefentry><refentrytitle>kevent</refentrytitle><manvolnum>2</manvolnum></citerefentry>, and notes not to access its output devices.
On acquire, it unmutes all of its input devices, with <code>EV_ENABLE</code> passed to <citerefentry><refentrytitle>kevent</refentrytitle><manvolnum>2</manvolnum></citerefentry>, and notes that it is permitted to access its output devices.
It also tells the kernel's built-in terminal emulator to do the complement, telling it not to draw output on the framebuffer nor to read input from the keyboard when that KVT is active.
</para>

<para>
<command>console-kvt-realizer</command> uses a kernel virtual terminal (KVT) for device sharing, and also for some I/O devices that they provide.
On the BSDs, the "kbio" keyboard input and "fbio" framebuffer output devices are accessible via a KVT, but the mouse input devices are not.
On Linux, only the "kbio" keyboard input devices are accessible via a KVT, but the framebuffer output and mouse input devices are not.
</para>

<note>
The X11 server <citerefentry><refentrytitle>Xorg</refentrytitle><manvolnum>1</manvolnum></citerefentry>, in particular its <code>config:devd</code> module, is faulty.
It dynamically opens all USB mice as they are attached to the system, but does so exclusively, preventing access to the devices by any other programs.
It should just open <filename>/dev/sysmouse</filename>, and rely upon the mouse device concentration already provided by <citerefentry><refentrytitle>moused</refentrytitle><manvolnum>8</manvolnum></citerefentry> and these realizers.
It actually does rely on input concentration for <emphasis>keyboard</emphasis> devices.
<citerefentry><refentrytitle>Xorg</refentrytitle><manvolnum>1</manvolnum></citerefentry> interferes both with the operation of the BSD <citerefentry><refentrytitle>moused</refentrytitle><manvolnum>8</manvolnum></citerefentry> and with <command>console-pcat-mouse-realizer</command>.
</note>

</refsection>

<refsection><title>console-kvt-realizer and the KVT</title>

<para>
<command>console-kvt-realizer</command> obtains the name of the KVT device from the value of the <envar>TTY</envar> environment variable, and assumes that its standard input and standard output are already connected to it.
One can invoke the realizer via <citerefentry><refentrytitle>vc-get-terminal</refentrytitle><manvolnum>1</manvolnum></citerefentry> or a similar command that obtains a virtual terminal device name from an abbreviation, or just supply the full device name.
To open the standard input and output one then chains through <citerefentry><refentrytitle>open-controlling-terminal</refentrytitle><manvolnum>1</manvolnum></citerefentry> or a similar command.
</para>
<note>
When using other commands ensure that the KVT device is set as the controlling terminal.
This is a quirk of the operating system kernels themselves, which require this in order for various parts of the mechanism to work.
</note>

<para>
At startup, <command>console-kvt-realizer</command> switches the virtual terminal display (if it is "fbio") into a suitable graphics mode, configures the ("kbio") input to deliver raw keycodes, and switches the line discipline (of the "kbio" device) to non-canonical input (i.e. "raw") mode (so that the raw keycodes are unmolested by the line discipline); switching all of these back to their saved prior settings upon its termination.
The realizer attempts to choose the highest resolution graphics mode available that has a 32-bit or 24-bit colour depth.
The <arg choice='plain'>--80-columns</arg> option constrains its choice to graphics modes that are no wider than 80 columns (1280 pixels).
</para>

</refsection>

</refsection>

</refsection>

<refsection><title>Autoconfiguration via device paths</title>

<para>
Resources used by the realizers, including what virtual terminals to attach to and keyboard map files, are autoconfigured based upon the identity of the I/O device being used and the <arg choice='plain'><replaceable>devicename</replaceable></arg> arguments supplied on the command line.
The configuration file and directory format is given in <citerefentry><refentrytitle>user-vt-realizer-configuration</refentrytitle><manvolnum>5</manvolnum></citerefentry>.
</para>

</refsection>

<refsection><title>Display features</title>

<para>
Virtual terminal display buffers encompass a "light/dark" screen flag and various kinds of glyph for the cursor and the pointer.
All of the cursor and pointer glyph types are supported.
The blinking attribute for the cursor is not, however, supported.
</para>

<para>
As with real DEC VTs, but unlike some terminal <emphasis>emulators</emphasis>, the "light/dark" flag causes foreground and background colours to be swapped when displaying every display cell, i.e. "reverse video".
The cursor is not realized by reverse video.
Rather, the foreground and background colours of the cell with the cursor are complemented against white.
</para>

</refsection>

<refsection><title>Fonts</title>

<para>
Virtual terminal display buffers have faint, boldface, italic, strikethrough, and underline attributes for character cells.
Only faint, boldface, and italic involve font support, mapping to four font weights (light, medium, demibold, and bold) and three slants (upright, italic, and oblique).
Strikethrough and underline attributes are rendered not through font selection but by overwriting the non-strikethrough non-underline glyphs with appropriate horizontal lines.
</para>

<para>
Fonts are loaded at program initialization and remain loaded thereafter.
To change fonts, it is necessary to stop and restart <command>console-fb-realizer</command>.
This does not, of course, affect the operation of the terminal emulator or the processes using the terminal.
</para>

<para>
Fonts are loaded from font files, which may be either in the FreeBSD "vtfont" format or in the straight 8&#xD7;16 unadorned bitmap format used by FreeBSD's "syscons".
(To convert an Adobe BDF format font file to "vtfont" format, use the FreeBSD <citerefentry><refentrytitle>vtfontcvt</refentrytitle><manvolnum>1</manvolnum></citerefentry> utility.)
Font files are specified by the <replaceable>filename</replaceable> in the various font command-line options.
</para>

<para>
The weight and slant are encoded via these command-line options, because meta-information about weight and slant is not in a font file itself (it usually being encoded in the filename).
Bitmap fonts contain just one glyph set.
The "vtfont" format has two glyph sets for a pair of unspecified weights.
</para>
<itemizedlist>
<listitem><para>
The "vtfont" command-line options
<arg choice='plain'>--vtfont-faint-r</arg>,
<arg choice='plain'>--vtfont-faint-o</arg>,
<arg choice='plain'>--vtfont-faint-i</arg>,
<arg choice='plain'>--vtfont-normal-r</arg>,
<arg choice='plain'>--vtfont-normal-o</arg>,
<arg choice='plain'>--vtfont-normal-i</arg>, and
<arg choice='plain'>--vtfont</arg>
load both sets of glyphs from a "vtfont" format font.
"normal" in the option name specifies that the presumed weights of the pair are medium and bold; "faint" specifies that the presumed weights are light and demibold.
"r", "o", and "i" specify the presumed slants as upright, oblique, and italic respectively.
</para></listitem>
<listitem><para>
The "font" command-line options
<arg choice='plain'>--font-light-r</arg>,
<arg choice='plain'>--font-light-o</arg>,
<arg choice='plain'>--font-light-i</arg>,
<arg choice='plain'>--font-medium-r</arg>,
<arg choice='plain'>--font-medium-o</arg>,
<arg choice='plain'>--font-medium-i</arg>,
<arg choice='plain'>--font-demibold-r</arg>,
<arg choice='plain'>--font-demibold-o</arg>,
<arg choice='plain'>--font-demibold-i</arg>,
<arg choice='plain'>--font-bold-r</arg>,
<arg choice='plain'>--font-bold-o</arg>, and
<arg choice='plain'>--font-bold-i</arg>
are the only way to load bitmap fonts, and can also be used to load just the first set of glyphs from a "vtfont" format font, providing fine-grained control of what glyphs are used if that is required.
Again, "r", "o", and "i" in the option name specify the presumed slants as upright, oblique, and italic respectively.
The four presumable weights in the option name are "light", "medium", "demibold", and "bold".
</para></listitem>
</itemizedlist>

<para>
Fonts must be monospace fonts with a height of 8, 14, 15, or 16 and a width of 8, 9, 12, or 16.
All glyphs are rendered in a 16&#xD7;16 bounding square, with 8&#xD7;8 pixel fonts doubled to 16&#xD7;16 pixels.
8&#xD7;16 pixel block graphic and box drawing characters are doubled in width.
Any "horizontally extendable" characters (such as the em dash) not otherwise extended to 16 pixels wide are extended by overlaying themselves to the right.
</para>

<refsection><title>Fallback behaviour</title>

<para>
If faint and demibold weights are unavailable, the faint attribute is emulated by shading the foreground and background colours towards black.
If bold weight is unavailable, the bold attribute is rendered by overlaying a glyph with a shifted copy of itself.
(The <arg choice='plain'>--bold-as-colour</arg> command-line option will as an alternative always render boldface by tinting foreground colours towards white, but this is of limited use with applications that employ 256-colour or true-colour terminal controls, as many do nowadays.)
If italic stroke is unavailable, the first fallback is to use an oblique font.
(Oblique is not the same as italic, note, and is often an inferior substitute for it.)
If neither italic nor oblique are available, the italic attribute is rendered by shifting the upright glyph into an oblique form within the character bounding square if the character size permits.
</para>

<para>
With no fonts loaded, and for any characters which cannot be found in the loaded fonts, <command>console-fb-realizer</command> "greeks" its output,
falling back to displaying a blank for any whitespace characters, a box for any C0 or C1 control characters, and a block for all other characters.
Such "greeking" is of course illegible; and it is recommended that sufficient fonts be loaded in order to render at least the whole of Microsoft's Windows Glyph List 4.
(One might be tempted to simply cover the OpenType World Glyph Set 1 character set instead.
Bear in mind that the W1G character set does not include line drawing, block, arrow, and other characters that are commonly employed by TUI systems to draw UI widgets; whereas WGL4 does.)
</para>

</refsection>

</refsection>

<refsection><title>Keyboard mapping</title>

<para>
A keyboard device realizer (<command>console-ugen-hid-realizer</command>, <command>console-evdev-realizer</command>, <command>console-uhid-realizer</command>, <command>console-wscons-realizer</command>, or <command>console-pcat-keyboard-realizer</command>) employs a loadable keyboard map to determine how input events from a keyboard device translate into keyboard messages sent to the input FIFO of a user-space virtual terminal.
The keyboard input event device provides a sequence of non-portable, device and operating system specific, keycode numbers, with attached press/release flags.
The realizer translates these keycodes into a portable logical keyboard, applies the actions defined in the keyboard map, in conjunction with the (shared or isolated) modifier state, resulting in keyboard messages.
</para>

<para>
The map file format is given in <citerefentry><refentrytitle>console-keyboard-map</refentrytitle><manvolnum>5</manvolnum></citerefentry>.
</para>

<refsection id="DEAD-KEYS" xreflabel="DEAD-KEYS"><title>Dead keys</title>

<para>
So-called "dead" keys are otherwise ordinary UCS-3 keys in a keyboard map, except that they denote Unicode combining characters; i.e. characters in the "Me" ("Mark, Enclosing") and "Mn" ("Mark, Non-spacing") Unicode code point categories.
The keyboard realizers  remember such "dead" keys, without transmitting them to the input FIFO as they are pressed (or autorepeated).
They attempt to combine them with the next non-combining character keypress.
In this respect they behave mostly according to ISO/IEC 9995-3 and DIN/EN 2137:
</para>

<itemizedlist>
<listitem><para>
The keyboard realizers implement the extra so-called "peculiar" combinations given by the ISO and DIN standards (and also found in several other national keyboard standards).
These are applied before attempting any Unicode composition.
Most of these involve:
</para>
<variablelist>
<varlistentry>
<term><code>COMBINING SHORT STROKE OVERLAY</code> (U+0335)</term>
<listitem><para>
In ISO 9995-3 keyboard layouts this is <keycap>Group2</keycap>+<keycap>&#x21eb;&#160;Level3</keycap>+<keycap>C08</keycap> (<keycap>&#x21e7;&#160;Shift</keycap>+<keycap>&#x2325;&#160;Option</keycap>, <keycap>&#x2325;&#160;Option</keycap>+<keycap>K</keycap> on the U.S. International keyboard).
Unicode does not define any compositions using this combining character.
</para></listitem>
</varlistentry>
<varlistentry>
<term><code>COMBINING LONG SOLIDUS OVERLAY</code> (U+0338)</term>
<listitem><para>
In ISO 9995-3 keyboard layouts this is <keycap>Group2</keycap>+<keycap>&#x21eb;&#160;Level3</keycap>+<keycap>C09</keycap> (<keycap>&#x21e7;&#160;Shift</keycap>+<keycap>&#x2325;&#160;Option</keycap>, <keycap>&#x2325;&#160;Option</keycap>+<keycap>L</keycap> on the U.S. International keyboard).
Unicode also defines compositions using this combining character.
The ISO 9995-3 compositions overlap in only one case, which is the same in both ISO 9995-3 and Unicode.
</para></listitem>
</varlistentry>
</variablelist>
</listitem>
<listitem><para>
The ISO and DIN standards define "peculiar" combinations with the space character that generate standalone accents.
Any sequence of "dead" keys followed by Space generates a sequence of precomposed non-combining accent characters that correspond to the combining characters.
</para></listitem>
<listitem><para>
The ISO and DIN standards are not specific about Unicode combining characters.
The keyboard realizers apply the "canonical" composition rules given by Unicode, attempting to produce a stream of input characters in Unicode Normalized Form C.
Any leftover combining characters that cannot be precomposed are treated as if combined with Space, and emitted before the composed character.
This differs from Unicode Normalization, where leftover combining characters always follow the "starter" character.
Having leftover combining characters precede the composed character both mimicks the existing behaviour of "dead" keys on several systems and is least surprising to the typist as it (roughly) preserves typed order.
(Typed order is not entirely preserved; the "dead" keys are sorted by Unicode combining class as a side-effect of NFC composition.)
</para></listitem>
<listitem><para>
Not all input is in Unicode Normalized Form C.
The ISO and DIN standards define a "pass-through" mechanism that allows a typist to enter combining characters as-is: any sequence of "dead" keys followed by the Zero-Width Non-Joiner (entered as <keycap>Group2</keycap>+<keycap>&#x21e7;&#160;Level2</keycap>+<keycap>A03</keycap> in ISO 9995-3 keyboard layouts; which is <keycap>&#x21e7;&#160;Shift</keycap>+<keycap>&#x2325;&#160;Option</keycap>, <keycap>&#x21e7;&#160;Shift</keycap>+<keycap>&#x2423;&#160;Space</keycap> on the U.S. International keyboard) generates that sequence of non-combining characters in typed order.
</para></listitem>
<listitem><para>
Full Unicode Normalization is not performed.
In particular, if the typist enters a precomposed character after the "dead" keys, it is not decomposed before the composition rules are applied.
This is done in order not to surprise the typist.
Full Unicode NFD decomposition followed by Unicode NFC composition could result in different leftover combining characters in some cases.
It also would perform various one-way transformations.
</para></listitem>
</itemizedlist>

</refsection>

</refsection>

<refsection><title>Security</title>

<para>
The realizers only require sufficient privileges to access their various I/O devices, the shared keyboard/mouse state files, the display buffer file (if they are output device realizers), the FIFO (if they are input device realizers).
They do not attempt to create the display file or FIFO if they do not exist, because this would create them with the wrong owner and group; and it thus requires no write access to their containing directory.
Owner access for any files, directories, FIFOs, or I/O devices is not necessary.
The shared keyboard/mouse state files <emphasis>may</emphasis> be owned by the dedicated user, but this is <emphasis>not</emphasis> not a requirement.
</para>

<para>
Superuser privileges are not necessary for all realizers, which should be invoked without superuser privileges, employing <citerefentry><refentrytitle>setuidgid</refentrytitle><manvolnum>1</manvolnum></citerefentry> or similar as necessary.
The recommended configuration is that there be a dedicated unprivileged user or group that owns no files, devices, directories, or FIFOs; that the I/O devices be (as appropriate) readable and writable (but not owned) by that user or group; that the display file and the FIFO are (respectively) readable and writable (but not owned) by that user or group; and that the shared keyboard/mouse state files are both readable and writable (but not owned) by that user or group.
</para>

<para>
The exception is <command>console-ugen-hid-realizer</command>.
That requires superuser access in order to detach any kernel device drivers from <citerefentry><refentrytitle>ugen</refentrytitle><manvolnum>4</manvolnum></citerefentry> devices.
After opening its devices and detaching their kernel device drivers, but before attempting to access font files or VT back-ends, it drops privileges in the manner of <citerefentry><refentrytitle>setuidgid-fromenv</refentrytitle><manvolnum>1</manvolnum></citerefentry>, and so requires that the appropriate environment variables have been set up via <citerefentry><refentrytitle>envuidgid</refentrytitle><manvolnum>1</manvolnum></citerefentry> or similar.
</para>

</refsection>

<refsection><title>Author</title>
<para><author><personname><firstname>Jonathan</firstname> <surname>de Boyne Pollard</surname></personname></author></para>
</refsection>

</refentry>
