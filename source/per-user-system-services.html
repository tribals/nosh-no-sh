<link rel="Up" href="per-user-stuff.html" title="Stuff converted for each user" />
<link rel="Stylesheet" type="text/css" href="guide.css" title="Guide default style" />
<title>Per-user system services</title>
<h1 class="Ruled">
Per-user system services
</h1>

<h2 class="Ruled">
Services created
</h2>

<p>
The configuration import subsystem creates several services at the system level for each user.
</p>

<h3 class="Ruled">
<code>user@</code><i>name</i>: user target
</h3>

<p>
An umbrella target named <code>user@</code><i>name</i> encompasses all of the other services.
Starting the target auto-starts all of the other services, if they are enabled.
</p>

<h3 class="Ruled">
<code>user-runtime@</code><i>name</i>: per-user runtime area
</h3>

<p>
This service creates (on startup) and destroys (on shutdown) the per-user runtime area for the user that is in <a href="gazetteer.html#user-runtime"><code>/run/user/</code><i>name</i></a>.
It wants and is ordered after any mount service for <code>/run/user</code> that may exist.
It wants and is ordered before any mount service for <code>/run/user/</code><i>name</i> that may exist.
The import subsystem does not generate or supply such mount services.
</p>

<h3 class="Ruled">
<code>user-services@</code><i>name</i>: per-user manager
</h3>

<p>
This service runs an instance of <a href="commands/per-user-manager.xml"><code>per-user-manager</code></a> as the user.
This in turn runs an instance of <a href="commands/service-manager.xml"><code>service-manager</code></a> that manages <a href="per-user-user-services.html">the per-user services</a>.
</p>

<h3 class="Ruled">
<code>user-dbus-daemon@</code><i>name</i>: per-user Desktop Bus broker
</h3>

<p>
This service runs an instance of <code>dbus-daemon</code> as the user.
It uses <a href="gazetteer.html#per-user.conf">a private configuration file</a> from the service definition that ensures that <a href="commands/dbus-daemon-launch-helper.xml"><code>dbus-daemon-launch-helper</code></a> is used to <a href="per-user-dbus-demand-start.html">demand-start servers</a>.
The socket that this broker listens on is in the conventional place at <a href="gazetteer.html#user-bus-socket"><code>/run/user/</code><i>name</i><code>/bus</code></a>.
</p>

<p>
This is an old way of starting up a per-user broker service.
It is usually not used in favour of a broker service that is run by the per-user service manager and thus directly configurable by the user.
The twain should not be used simultaneously.
</p>

<h2 class="Ruled">
Usage
</h2>

<p>
If you want a user <code>fred</code>'s per-user service management to be auto-started started at bootstrap, simply enable either the <code>user-services@fred</code> service specifically, or enable the <code>user@fred</code> target as a whole.
</p>

<p>
To have user <code>fred</code>'s per-user service management start when <code>fred</code> first logs in, have <code>system-control start user@fred</code> (run by the superuser, of course) as part of the login process.
</p>

<p>
One easy way to do this is to run <a href="commands/login-monitor-active.xml"><code>login-monitor-active</code></a> as a service.
This is effectively an equivalent to an UPSERT/DELETE trigger on the active logins table in <a href="https://jdebp.uk/FGA/unix-login-database.html">Unix login database</a>.
Whenever anything uses the <a href="https://pubs.opengroup.org/onlinepubs/9799919799/basedefs/utmpx.h.html">standard "utmpx" Unix API</a> to manipulate that table, <code>login-monitor-active</code> notices and spawns <a href="commands/system-control.xml"><code>system-control</code></a> if any users have wholly (on all terminals) logged out or newly logged in.
</p>
<p class="note"> <strong> Note: </strong>
<a href="commands/login-monitor-active.xml"><code>login-monitor-active</code></a> does not start the old-style per-user broker service.
You must use the new-style of a user-level <code>dbus-daemon</code> service if you use <code>login-monitor-active</code>.
</p>

<p>
Users do not have to run any per-user services at all, of course.
</p>
