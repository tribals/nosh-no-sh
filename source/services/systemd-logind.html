<link rel="Up" href="../index.html" title="nosh Guide" />
<link rel="Stylesheet" type="text/css" href="../guide.css" title="Guide default style" />
<title>The systemd-logind service, and elogind</title>
<h1 class="Ruled">
The systemd-logind service, and elogind
</h1>

<div class="sidebar">
<p>
systemd-logind, its tight coupling to systemd, and the way that <em>all</em> such systemd components were packaged together instead of being separately installable was the cause of <a href="https://jdebp.uk/FGA/debian-systemd-packaging-hoo-hah.html">the Debian systemd Packaging Hoo-Hah</a> in 2014, and remains a problem to this day.
</p>
</div>

<p>
You almost certainly have no need of the systemd-logind service, and it is part of how systemd makes a right old pig's ear of a machine that is supposedly not using systemd.
(You almost certainly have no need of elogind, either.)
</p>

<p>
Non-Linux-based operating system operators can stop here, because neither systemd-logind nor elogind apply to anything other than Linux-based operating systems; and there is no "almost" about it.
Although <a href="https://skarnet.org/software/utmps/">Laurent Bercot's utmps</a>, mentioned below, may be of some interest; albeit that the <a href="https://jdebp.uk/FGA/unix-login-database.html">Unix login database</a> and <a href="https://pubs.opengroup.org/onlinepubs/9799919799/basedefs/utmpx.h.html">standard "utmpx" Unix API</a> are hardwired into the bases of most non-Linux-based operating systems and are not replaceable components.
</p>

<h2 class="Ruled" id="Background">Background</h2>

<h3 class="Ruled" id="What">What systemd-logind does</h3>

<p>
The <a href="https://jdebp.uk/FGA/unix-login-database.html">Unix login database</a> has been around since the 1970s, and has undergone at least two revisions on most operating systems, adding fields to and extending field widths in fixed-length-record tables.
It has numerous problems to this day, not the least of which is that in order to allow user applications like GUI terminal emulators to register themselves as login sessions, the tables have to be writable by at minimum a special group that is applied set-GID to a helper program.
In several modern operating systems, it is now considered defunct, and system programs do not maintain the table data as they once did.
</p>

<p>
<a href="https://skarnet.org/software/utmps/">Laurent Bercot's utmps</a> was one project to solve this (as a stop-gap measure only, and particularly aimed at systems using musl libc).
It provided replacements for the "utmpx" routines in the system C library that instead of accessing the login database directly talked to what was essentially a database server, which handled security restrictions on the actual table files and concurrency.
It kept the idea that the actual database comprised machine-readable data files, and it kept the <a href="https://pubs.opengroup.org/onlinepubs/9799919799/basedefs/utmpx.h.html">long-standing standard "utmpx" Unix API</a>.
It is self-contained with low coupling: relying upon no other servers internally; not bringing in nor setting up any other software mechanisms to run, in its software packaging; and severable and replaceable, at two different points, with something else to provide either the Unix API or just the database server part, should the need arise.
</p>

<p>
systemd-logind is essentially a reinvention of the same client-server idea, except that:
</p>
<ul>
<li><p>
The Unix API is not retained; instead applications have to speak an entirely new Desktop Bus API (<a href="https://freedesktop.org/software/systemd/man/latest/org.freedesktop.login1.html">org.freedesktop.login1</a>), indirectly via the Desktop Bus broker.
This new API covers far more than just a login database.
</p></li>
<li><p>
The server requires <em>other</em> servers to be run.
</p></li>
<li><p>
It is not packaged as a self-contained decoupled thing, separately installable/deinstallable from other things.
It is in <a href="https://packages.debian.org/sid/systemd#pdownload">the all-in-one systemd package</a> that contains everything from Z shell extensions through systemd-logind to systemd's own kernel plus "Initial RAM disc" installer.
</p></li>
<li><p>
The machine-readable flat table files are replaced by human-readable one-file-per-record files under <code>/run/systemd/users/</code>, <code>/run/systemd/seats/</code>, and <code>/run/systemd/sessions/</code>.
These are all parsed at runtime from human-readable to machine form by systemd softwares, and come with notices in comments on their first lines that they must not be parsed.
</p></li>
</ul>

<h3 class="Ruled" id="PigsEar">The systemd pig's ear</h3>

<div class="sidebar">
<p> Examples of extreme pinning instructions: </p>
<ul>
<li> <a href="https://christitus.com/removing-systemd/"><i>Removing Systemd</i></a> by Chris Titus </li>
<li> <a href="https://ervinbarta.com/2017/01/28/prevent-systemd-installation-on-ubuntu-and-debian/"><i>Prevent systemd installation on Ubuntu 14.04 and other Debian based distros</i></a> by Ervin Barta </li>
<li> <a href="https://unix.stackexchange.com/a/316745/5132"><i>systemd apt pinned to -1 and installed in upgrade from Debian 8 to Debian 9</i></a> by Rui F Ribeiro </li>
<li> <a href="https://news.ycombinator.com/item?id=44663817"><i>The easiest way to make this transition</i></a> by bbarnett </li>
</ul>
</div>

<p>
Conventional wisdom on Debian Linux when not using systemd is to not only uninstall all of the systemd packages, "essential" and otherwise, but to "pin" their installation priority to an impossible negative value to ensure that they are never auto-installed by APT/dpkg.
This may seem extreme, and to an extent it is.
One can run nosh service and system management where systemd software is present but unused.
<p>

<p>
But unfortunately, the extreme pinners have a point; because in such a scenario systemd mechanisms auto-start by unexpected and undocumented routes, generate a lot of log noise, and yet do not meaningfully function or yield any benefit.
What happens is this:
<p>

<ol>
<li><p>
The system starts from a position where the system-wide Desktop Bus broker is running, because other services require it, but no systemd things are running.
The <a href="../external-formats.html">the external formats conversion mechanism</a> has converted the system-wide Desktop Bus "service" files and <a href="../commands/dbus-daemon-launch-helper.xml"><code>dbus-daemon-launch-helper</code></a> is in place to turn the highly flawed and wrongheaded <a href="http://freedesktop.org./wiki/IntroductionToDBus/#activation">Desktop Bus activation</a> into instead proper service control actions.
</p><p>
In particular, the <a href="https://github.com/systemd/systemd/blob/main/src/login/org.freedesktop.login1.service#L10"><code>/usr/lib/dbus-1/system-services/org.freedesktop.login1.service</code></a> file has been processed.
This file is installed by the all-in-one systemd package.
Because of it, attempts to "Desktop Bus activate" <code>org.freedesktop.login1</code> will be diverted to starting a proper <code>org.freedesktop.login1</code> service, which (as for other Desktop Bus "bus names") is an alias of <a href="https://github.com/systemd/systemd/blob/main/units/systemd-logind.service.in#L25">the actual service that "provides" that "bus name"</a> on the Desktop Bus.
In this case the actual service is the <code>systemd-logind</code> service.
</p></li>
<li><p>
Because the systemd packages are still installed, they have run <code>pam-auth-upate</code> to (per <a href="https://sources.debian.org/src/systemd/257.7-1/debian/extra/pam-configs/systemd/">the systemd PAM profile</a>) automatically install the <code>pam_systemd.so</code> module into the package-managed-do-not-touch part of the <code>/etc/pam.d/common-session</code> PAM configuration file.
This means that anything using PAM to create and destroy login sessions &mdash; e.g. programs such as <code>login</code>, <code>su</code>, <code>sshd</code>, and <a href="../commands/login-envuidgid.xml"><code>login-envuidgid</code></a> &mdash; will run the <code>pam_systemd.so</code> hooks into the log-on/log-off process.
</p></li>
<li><p>
These hooks attempt to tell systemd-logind about login sessions appearing and disappearing.
<code>pam_systemd.so</code>, in the normal way for Desktop Bus things, contacts the Desktop Bus broker asking for the <a href="https://freedesktop.org/software/systemd/man/latest/org.freedesktop.login1.html">org.freedesktop.login1</a> server.
</p></li>
<li><p>
The Desktop Bus broker, via <a href="../commands/dbus-daemon-launch-helper.xml"><code>dbus-daemon-launch-helper</code></a> and as a consequence of that <code>/usr/lib/dbus-1/system-service/org.freedesktop.login1.service</code> file, ends up running <a href="../commands/system-control.xml"><code>system-control</code></a>&nbsp;<code>start</code>&nbsp;<code>org.freedesktop.login1</code> and thus starting the <code>systemd-logind</code> service.
</p><p>
On a system actually using systemd, <code>systemd-logind.service</code> would already be running and already registered with its "bus name".
However, systemd has hooks into Desktop Bus such that if systemd is running much the same sort of diversion, from "Desktop Bus activation" to starting a real systemd service, would happen if it <em>were not</em> started.
This is not some novel mechanism at all, and <a href="https://jdebp.uk/Softwares/nosh/avoid-dbus-bus-activation.html">at one point years ago the Upstart developers tried to add similar hooks for Upstart (only to have that blocked by the systemd developers)</a>.
</p></li>
<li><p>
systemd-logind having started and registered itself with its "bus name" on the system-wide Desktop Bus, <code>pam_session.so</code> can now talk to its Desktop-Bus-Flavoured replacement for the Unix "utmpx" API.
<code>pam_session.so</code> tells systemd-logind about log-in/log-out activity.
</p></li>
<li><p>
One of the several things that systemd-logind does, though, is speak to <em>another</em> Desktop Bus service, this one named <a href="https://freedesktop.org/software/systemd/man/latest/org.freedesktop.systemd1.html">org.freedesktop.systemd1</a>.
When things tell it about login sessions and virtual terminals coming and going, it translates this into requests to systemd to start/stop a whole load of things, including <code>session-<i>number</i>.scope</code> units, <code>user@<i>UID</i>.service</code> units, <code>user-runtime@<i>UID</i>.service</code> units, and <code>autovt@<i>device</i>.service</code> units, amongst others.
</p></li>
<li><p>
The Desktop Bus broker, via <a href="../commands/dbus-daemon-launch-helper.xml"><code>dbus-daemon-launch-helper</code></a> and as a consequence of a parallel <a href="https://github.com/systemd/systemd/blob/main/src/login/org.freedesktop.systemd1.service#L10"><code>/usr/lib/dbus-1/system-service/org.freedesktop.systemd1.service</code></a> file, ends up running <a href="../commands/system-control.xml"><code>system-control</code></a>&nbsp;<code>start</code>&nbsp;<code>org.freedesktop.systemd1</code>.
</p><p>
Fortunately, there is no service bundle with this "bus name" as its alias, but the intent is to "Desktop Bus activate" the main systemd program itself.
By a circuitous, undocumented, and unexpected route, the mere fact that the systemd packages are installed has led, step by step, to attempting to start two of the major parts of systemd.
</p></li>
</ol>

<p>
This is not the only place where "Desktop Bus activation", and the strong coupling between and weak cohesion within systemd modules, leads to this sort of thing.
There are other systemd hooks in addition to the PAM module, put in place by systemd package installation, that start up systemd stuff by roundabout routes, such as the <code>systemd</code> source in <code>/etc/nsswitch.conf</code> that attempts to contact <a href="https://freedesktop.org/software/systemd/man/latest/org.freedesktop.resolve1.html">org.freedesktop.resolve1</a> over the Desktop Bus and thus automatically starts the <code>systemd-resolved</code> service.
</p>

<h2 class="Ruled" id="AvoidingStrongCoupling">Avoiding strong coupling</h2>

<div class="sidebar">
<p>
The important things to realize are:
</p>
<ul>
<li><p>
Hooks into PAM are not actually required to do this in the first place.
The better way of thinking about this is as an UPSERT/DELETE trigger on the active logins table in the Unix login database.
How that works depends from the database implementation, but the traditional method of machine-readable flat table files simply requires a vnode watcher.
</p></li>
<li><p>
The aforegoing can be entirely separated from monitoring which Linux kernel virtual terminal is the active one.
The two do not have to be intertwined into a single program, speaking a single API, running as a single service.
</p></li>
</ul>
</div>

<p>
The nosh toolset tries to mitigate this strong coupling in several ways:
</p>
<ul>
<li><p>
<em>Its own</em> packages are split into packages that install files, and packages that enable stuff to run.
</p></li>
<li><p>
As of version 1.41, the <code>org.freedesktop.login1</code> "bus name" is specially deny-listed by the <a href="../external-formats.html">the external formats conversion mechanism</a> so that it creates no <code>org.freedesktop.login1</code> service.
This does result in some log noise from the Desktop Bus broker service, however, as it will report repeated failures to activate a service for this "bus name".
</p></li>
<li><p>
The <code>org.freedesktop.systemd1</code> "bus name" is also specially deny-listed by the <a href="../external-formats.html">the external formats conversion mechanism</a>.
</p></li>
<li><p>
One function of systemd-logind, not de-coupleable from its other functions in systemd itself, is replaced by the standalone <a href="../commands/ttylogin-starter.xml"><code>ttylogin-starter</code></a> utility running as a service.
This mechanism is self-contained, the program not doing other things at the same time, and entirely optional; one can just set up terminals in <code>/etc/ttys</code>, never use it at all, and the system functionality will not be degraded in other areas because this specific service is not running.
</p></li>
<li><p>
Another function of systemd-logind, not de-coupleable from its other functions in systemd itself, is replaced by the standalone <a href="../commands/login-monitor-active.xml"><code>login-monitor-active</code></a> utility running as a service.
This is similarly self-contained and entirely optional.
It expects the conventional login database files in the conventional places, but if another login database system comes along it can be disabled and something else run in its place without losing or degrading other parts of the system.
</p></li>
</ul>

<p>
<a href="https://github.com/elogind/elogind">GUIX's/Devuan's elogind</a> addresses the strong coupling by being a systemd-logind shim that speaks the Desktop Bus API, but does very little, with most of the functionality stubbed out.
In particular, it does not actually do the things that <a href="../commands/ttylogin-starter.xml"><code>ttylogin-starter</code></a> and <a href="../commands/login-monitor-active.xml"><code>login-monitor-active</code></a> do, at all.
So it does not provide very much of its own apart from a dummy service to answer <code>pam_systemd.so</code> and its ilk, and one still needs the nosh-toolkit-supplied services to get
</p>
